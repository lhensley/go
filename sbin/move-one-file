#!/bin/bash
# move-one-file
# Usage: move-one-file <input_file> <root_in_path> <root_out_path>
# No final / on either path. For system root, use ""

production_mode=true
debug_mode=false
# debug_mode=true
if $debug_mode ; then
  set -x
  fi

IN_FILE=$1
ROOT_IN_PATH=$2
ROOT_OUT_PATH=$3

ROOT_IN_PATH_LENGTH=${#ROOT_IN_PATH}

RELATIVE_FILE_LENGTH=$[IN_FILE_LENGTH-ROOT_IN_PATH_LENGTH-1]
RELATIVE_FILE=${IN_FILE: -$RELATIVE_FILE_LENGTH} # Remove ROOT_IN_PATH

OUT_FILE="$ROOT_OUT_PATH/$RELATIVE_FILE"
NEW_DIRECTORY=$(dirname "$OUTFILE")

# So here are useful variables defined ...
# $IN_FILE
# $OUT_FILE
# $ROOT_IN_PATH
# $ROOT_OUT_PATH
# $RELATIVE_FILE

# Make sure only root can run our script
if [[ $EUID -ne 0 ]]; then
  echo "This script must be run as root."
  exit 1
fi

echo "V31" | mail lanecell
sleep 2
echo "IN_FILE $IN_FILE" | mail lanecell
echo "OUT_FILE $OUT_FILE" | mail lanecell
echo "ROOT_IN_PATH $ROOT_IN_PATH" | mail lanecell
echo "ROOT_OUT_PATH $ROOT_OUT_PATH" | mail lanecell
echo "RELATIVE_FILE $RELATIVE_FILE" | mail lanecell
echo "Dir to make: $NEW_DIRECTORY" | mail lanecell
exit 0

# Make sure $IN_FILE is not in use
if [ -n "$(lsof "$IN_FILE" 2>/dev/null)" ]; then
    logger "$0: File in use and cannot move $IN_FILE"
    echo "$0: File in use and cannot move $IN_FILE" | mail lanecell
    exit $exit_status
  fi

# Make the directory for out file
if [ ! -d "$NEW_DIRECTORY" ]; then
  mkdir -p "$NEW_DIRECTORY" >> /dev/null 2>&1 # Create the directory for the out file
  exit_status=$?
  if [ $exit_status -ne 0 ]; then # If the transcoding failed ...
      logger "$0 FAILED to make $NEW_DIRECTORY"
      echo "Failed to make $NEW_DIRECTORY" | mail lanecell
      exit $exit_status
      fi
  fi

# Move $IN_FILE to $OUT_FILE
mv "$IN_FILE" "$OUT_FILE" >> /dev/null 2>&1
exit_status=$?
if [ $exit_status -ne 0 ]; then # If the transcoding failed ...
    logger "$0 FAILED to move $IN_FILE to $NEW_DIRECTORY"
    echo "Failed to move to $RELATIVE_FILE" | mail lanecell
    echo "Source $IN_FILE" | mail lanecell
    echo "Target dir $NEW_DIRECTORY" | mail lanecell
    echo "Target $OUT_FILE" | mail lanecell
    exit $exit_status
  else
    logger "$0 moved $IN_FILE to $NEW_DIRECTORY"
  fi

exit 0
