#!/bin/bash
# _git

# Include script setup file
	source script-setup
	if [ ! $FUNCTIONS_ARE_DEFINED ]; then echo $0: Functions not defined. Aborting; logger $0: Functions not defined. Aborting; exit 1; fi
	if [ ! $VARIABLES_ARE_DEFINED ]; then echo $0: Variables not defined. Aborting; logger $0: Variables not defined. Aborting; exit 1; fi

# Require root
	r_require_root

# Install git token
# To get a new token, go to https://github.com/settings/tokens.
	git config --global url."https://api:$GIT_TOKEN@github.com/".insteadOf "https://github.com/"
	git config --global url."https://ssh:$GIT_TOKEN@github.com/".insteadOf "ssh://git@github.com/"
	git config --global url."https://git:$GIT_TOKEN@github.com/".insteadOf "git@github.com:"

# This section re-pulls all go files from github and updates $SBIN_DIR
	# Change to local repository directory
		CURRENT_DIRECTORY=$(pwd)
		cd $GIT_GO
	# Blow away any local changes not uploaded to github
		git reset --hard
	# Select the designated branch
		git checkout $GIT_BRANCH
	# Pull down a copy of the repository
		git pull
	# Set permissions for git directory
		chmod -R 400 $GIT_ROOT
	# Copy scripts into $SBIN_DIR
		rm -rf $SBIN_DIR
		cp -r $GIT_GO_SBIN $SBIN_PARENT
		cd $CURRENT_DIRECTORY
		logger $0: git branch $GIT_BRANCH pulled.

# Set ownership and permissions in $SBIN_DIR (to be overwritten by _apply-configs)
	chown -R $ROOT_USER:$ROOT_USER $SBIN_DIR
	find $SBIN_DIR -type d -print -exec chmod 755 {} \; >> /dev/null 2>&1
	find $SBIN_DIR -type f -print -exec chmod 755 {} \; >> /dev/null 2>&1

# Invoke /usr/local/sbin/_apply-configs
	$SBIN_DIR/_apply-configs

# Include script footer file
	f_debug_variable "script_footer" "${PATHNAME[script_footer]}"
	source "${PATHNAME[script_footer]}"

exit 0

