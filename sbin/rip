#!/bin/bash
# rip

# Include script setup file
	source script-setup
	if [ ! $FUNCTIONS_ARE_DEFINED ]; then echo $0: Functions not defined. Aborting; logger $0: Functions not defined. Aborting; fi
	if [ ! $VARIABLES_ARE_DEFINED ]; then echo $0: Variables not defined. Aborting; logger $0: Variables not defined. Aborting; fi

if [ -z "$1" ]; then
  echo "Usage: rip \"Title (year) [ movie | <minimum_number_of_seconds> ]\" &"
  exit -1
  fi

if [ -z "$2" ]; then
    MINLENGTH=1200
  else if [ "$2" == "movie" ]; then
    MINLENGTH=4500
    else MINLENGTH=$2
    fi
  fi

f_require_value "MakeMKV Program Path" "${PATHNAME[makemkvcon]}"
f_require_value "MakeMKV Output Directory" "$MAKEMKV_OUTPUT_DIRECTORY"

mkdir -p "$MAKEMKV_OUTPUT_DIRECTORY/$1"
f_require_directory "$MAKEMKV_OUTPUT_DIRECTORY/$1"

sudo -u $RUN_AS "${PATHNAME[makemkvcon]}" --minlength=$MINLENGTH mkv disc:0 all "$MAKEMKV_OUTPUT_DIRECTORY/$1"
exit_status=$?
if [ $exit_status -eq 0 ] ; then
  echo "$1: Disk ripping completed successfully." | mail "$TEXT_ALERTS"
  else echo "$1: Disk ripping FAILED. Code $exit_status" | mail "$TEXT_ALERTS"
  fi
eject

# Include script footer file
	f_debug_variable "script_footer" "${PATHNAME[script_footer]}"
	source "${PATHNAME[script_footer]}"

exit $exit_status
