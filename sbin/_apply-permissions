#!/bin/bash
# _apply-permissions

# Invoked by _apply-configs

# Include script setup file
	source script-setup
	if [ ! $FUNCTIONS_ARE_DEFINED ]; then echo $0 Functions not defined. Aborting; logger $0 Functions not defined. Aborting; fi
	if [ ! $VARIABLES_ARE_DEFINED ]; then echo $0 Variables not defined. Aborting; logger $0 Variables not defined. Aborting; fi

# Set ownership and permissions in $SBIN_DIR
	chown -fR $ROOT_USER:$ROOT_USER $SBIN_DIR
#	find $SBIN_DIR -type d -print -exec chmod -f 755 {} \;
#	find $SBIN_DIR -type f -print -exec chmod -f 755 {} \;

# Exceptions: These can be read or run by anyone
	# These based on functional requirements
		chmod -f 755 ${PATHNAME[currenttimeinseconds]}
		chmod -f 755 ${PATHNAME[intervalinseconds]}
		chmod -f 755 ${PATHNAME[lhlib]}
		chmod -f 755 ${PATHNAME[process_incoming_scans]}
		chmod -f 755 ${PATHNAME[rip]}
		chmod -f 755 ${PATHNAME[script_footer]} 
		chmod -f 755 ${PATHNAME[script_setup]} 
		chmod -f 755 ${PATHNAME[timeformat]}
		chmod -f 755 ${PATHNAME[transcode_ripped_dvds]}
	# These based on desire. CAUTION: Don't expose anything that has a password or code in it.
		chmod -f 740 ${PATHNAME[upd]} 
		chmod -f 740 ${PATHNAME[_apply_configs]}

# ddclient
	chmod -f 600 /etc/ddclient.conf /etc/default/declient
	chown -f $ROOT_USER:$ROOT_USER /etc/ddclient.conf /etc/default/declient

# Git
	chmod -f 600 $ROOT_HOME_DIR/.gitconfig
	chmod -f 600 $ADMIN_HOME_DIR/.gitconfig
	chown -f $ROOT_USER:$ROOT_USER $ROOT_HOME_DIR/.gitconfig
	chown -f $ADMIN_USER:$ADMIN_USER $ADMIN_HOME_DIR/.gitconfig
	chmod -fR 400 $GIT_ROOT

# fstab
	chown -f $ROOT_USER:$ROOT_USER /etc/fstab*
	chmod -f 664 /etc/fstab*

# lsyncd
	chown -f $ROOT_USER:$ROOT_USER /etc/lsyncd/lsyncd.conf.lua
	chmod -f 600 /etc/lsyncd/lsyncd.conf.lua

# resolvconf
	chown -f $ROOT_USER:$ROOT_USER /etc/resolvconf/resolv.conf.d/head
	chmod -f 644 /etc/resolvconf/resolv.conf.d/head

# .ssh/authorized_keys
	chown -fR $ADMIN_USER:$ADMIN_USER $ADMIN_HOME_DIR/.ssh
	chown -fR $ROOT_USER:$ROOT_USER $ROOT_HOME_DIR/.ssh
	chmod -fR 600 $ADMIN_HOME_DIR/.ssh $ROOT_HOME_DIR/.ssh

# SSHD config file
	chmod -f 644 "$SSHD_CONFIG"
	chown -f $ROOT_USER:$ROOT_USER "$SSHD_CONFIG"

# HandBrake config file
	chmod -fR 600 $ADMIN_HOME_DIR/.HandBrake/*
	chown -fR $ADMIN_USER:$ADMIN_USER $ADMIN_HOME_DIR/.HandBrake $ADMIN_HOME_DIR/Videos
	chown -fR $ROOT_USER:$ROOT_USER $ROOT_HOME_DIR/.HandBrake

# Vim and vi config files
	chmod -f 600 $ADMIN_HOME_DIR/.vim*
	chown -f $ADMIN_USER:$ADMIN_USER $ADMIN_HOME_DIR/.vim*
	chown -f $ROOT_USER:$ROOT_USER $ROOT_HOME_DIR/.vim*

# Include script footer file
	f_debug_variable "script_footer" "${PATHNAME[script_footer]}"
	source "${PATHNAME[script_footer]}"

exit 0

